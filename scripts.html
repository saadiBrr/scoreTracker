<script>
    let numPlayers = 1;
    let striker = 1;
    let nonStriker = 0;
    let players = {};
    let wickets = [];
    let wicketsRemaining = 0;
    let overs = 0;
    let ballsThisOver = 0;
    let totalBallsPerOver = 6;
    let totalRuns = 0;
    let totalBalls = 0;
    let remainingPlayers = [];

    function updatePlayerNames() {
        let selectedPlayers = parseInt(document.getElementById('players').value);
        if (selectedPlayers !== numPlayers) {
            numPlayers = selectedPlayers;
            updateNonStriker()
        }

        let playerNamesHTML = '';
        for (let i = 1; i <= numPlayers; i++) {
            let playerName = players[i] ? players[i].name : '';
            playerNamesHTML += `
        <div>
            <label for="player${i}">Player ${i} Name:</label>
            <input type="text" id="player${i}" value="Player ${i}"> &nbsp;&nbsp;
            <label for="wickets${i}">Wickets:</label>
            <select id="wickets${i}">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>`;
        }
        document.getElementById('playerNames').innerHTML = playerNamesHTML;
    }

    function updateScorecard() {
        let scorecard = document.getElementById('scorecard');
        scorecard.style.fontSize = '22px'
        scorecard.innerHTML = '';
        for (let player in players) {
            // console.log(`Runs for player ${player}:`, players[player].runs);
            // console.log(`Balls faced for player ${player}:`, players[player].balls);
            let strikeRate = players[player].balls > 0 ? (players[player].runs / players[player].balls * 100).toFixed(2) : '0.00';
            // console.log(`Strike rate for player ${player}:`, strikeRate);
            scorecard.innerHTML += `<p id="player${player}" class="${striker === parseInt(player) ? 'on-strike' : ''}">${players[player].name}: ${players[player].runs} (${players[player].balls}) [4s: ${players[player].fours}, 6s: ${players[player].sixes}, Extras: ${players[player].extras}, Strike Rate: ${strikeRate}]</p>`;
        }
    }

    function updateScore() {
        let totalRuns = 0;
        let totalBalls = 0;

        for (let player in players) {
            totalRuns += players[player].runs;
            totalBalls += players[player].balls;
        }

        let oversCompleted = Math.floor(totalBalls / totalBallsPerOver);
        let ballsRemaining = totalBalls % totalBallsPerOver;

        let runRate = totalRuns > 0 ? totalRuns / (totalBalls / 6) : 0; // Calculate run rate
        if (isNaN(runRate)) {
            runRate = 0; // Set run rate to 0 if it's NaN
        }

        let score = document.getElementById('score');
        score.innerHTML = `${totalRuns}/${wickets.length} (${oversCompleted}.${ballsRemaining} overs) Run Rate: ${runRate.toFixed(2)}`;

        // Update the UI to display the list of wickets
        let wicketsList = document.getElementById('wickets-list');
        if (!wicketsList) {
            console.warn("Wickets list element not found.");
            return; // Exit function if element not found
        }

        // Clear any existing content inside the wickets list
        wicketsList.innerHTML = '';

        // Check if there are no wickets
        if (wickets.length === 0) {
            // If no wickets have fallen, display a message
            let listItem = document.createElement('li');
            listItem.textContent = "No wickets have fallen.";
            wicketsList.appendChild(listItem);
        } else {
            // Loop through each wicket in the wickets array
            wickets.forEach((wicket, index) => {

                // Create a new list item element for the wicket
                let listItem = document.createElement('li');

                // Set the text content of the list item to display wicket information
                listItem.textContent = `Wicket ${index + 1}: ${wicket.batsman} (b ${wicket.bowler})`;

                // If bowler information is available and wicket is credited, add it to the text content
                if (wicket.bowler && wicket.credited) {
                    listItem.textContent += ` (b ${wicket.bowler})`;
                }

                // Append the created list item to the wickets list element
                wicketsList.appendChild(listItem);
            });
        }
    }

    function endGame() {

    }

    function addWicket() {
        // Increment balls faced for the striker
        players[striker].balls++;

        // Decrement wickets remaining for the striker
        let wicketsRemainingSelect = document.getElementById(`wickets${striker}`);
        let wicketsRemaining = parseInt(wicketsRemainingSelect.value);
        wicketsRemaining--;
        let ballsFaced = players[striker].balls

        if (wicketsRemaining > 0) {
            console.log(players[striker].name + " has lost a wicket. He has " + wicketsRemaining + " remaining.");
        }

        // Check if the striker has lost all their wickets
        if (wicketsRemaining === 0) {
            if (ballsFaced === 1) {
                console.log((players[striker].name) + " is all out at " + players[striker].runs + " runs off " + players[striker].balls + " ball")
            } else {
                console.log((players[striker].name) + " is all out at " + players[striker].runs + " runs off " + players[striker].balls + " balls")
            }

            // Remove the player from the strike and mark them as out
            document.getElementById(`player${striker}`).classList.remove('on-strike');
            document.getElementById(`player${striker}`).classList.add('out'); // Add the "out" class


            console.log("added out to player")

            // Switch strike if there are remaining players
            let remainingPlayers = getRemainingPlayers();
            if (remainingPlayers.length > 0) {
                // Find the next player with wickets
                let nextPlayerIndex = (remainingPlayers.indexOf(striker) + 1) % remainingPlayers.length;
                striker = remainingPlayers[nextPlayerIndex];
                document.getElementById(`player${striker}`).classList.add('on-strike');

                // Set the next player as non-striker if the wicket fell on the last ball of the over
                if (ballsThisOver === totalBallsPerOver) {
                    nonStriker = striker;
                }
            }
        }

        // Update wickets remaining for the striker
        wicketsRemainingSelect.value = wicketsRemaining;

        // Create a new wicket object and add it to the wickets array
        let wicket = {
            batsman: document.getElementById(`player${striker}`).value,
            bowler: null,
            credited: false
        };
        wickets.push(wicket);

        // Update UI to display wickets
        updateScore();
        updateScorecard();

        // Check if all players are out
        if (getRemainingPlayers().length === 0) {
            let endGameConfirmation = confirm("All players are out. Do you want to end the game?");
            if (endGameConfirmation) {
                endGame(); // Call function to end the game
            } else {
                console.log("Game continues.");
            }
        }
    }

    // Function to count the number of players with wickets remaining
    function getRemainingPlayers() {
        for (let i = 1; i <= numPlayers; i++) {
            let wicketsRemaining = parseInt(document.getElementById(`wickets${i}`).value);
            if (wicketsRemaining > 0) {
                remainingPlayers.push(i);
            }
        }
        return remainingPlayers;
    }

    function startGame() {
        console.log('Starting Game');
        let numOvers = parseInt(document.getElementById('overs').value);
        numOvers = isNaN(numOvers) || numOvers <= 0 ? Infinity : numOvers; // Default to Infinity if invalid or 0
        console.log("numPlayers is " + numPlayers + " and numOvers is " + numOvers);

        let playerNames = [];
        for (let i = 1; i <= numPlayers; i++) {
            let playerName = document.getElementById('player' + i).value;
            if (playerName.trim() !== '') {
                playerNames.push(playerName);
            }
        }

        if (playerNames.length === numPlayers || numPlayers === 1) {
            for (let i = 1; i <= numPlayers; i++) {
                players[i] = { name: playerNames[i - 1], runs: 0, balls: 0, fours: 0, sixes: 0, extras: 0, notOut: 0 };
            }

            document.getElementById('playerNames').classList.add('hidden');
            document.getElementById('playerSelection').classList.add('hidden');
            document.getElementById('startButton').classList.add('hidden');
            document.getElementById('oversInput').classList.add('hidden');
            document.getElementById('score').classList.remove('hidden');
            document.getElementById('scorecard').classList.remove('hidden');
            document.getElementById('runButtons').classList.remove('hidden');

            updateScore();
            updateScorecard();
            document.getElementById('player1').classList.add('on-strike');
        } else {
            alert('Please enter names for all players.');
        }
    }

    function switchOver() {
        ballsThisOver = 0;
        overs++; // Increment the over count
        updateScore();
    }

    function switchStrike() {
        if (numPlayers === 1) {
            console.log("Only one player selected. Cannot switch strike.");
            return; // Exit function if only one player
        }

        // Update the striker and non-striker variables
        let temp = striker;
        striker = nonStriker;
        nonStriker = temp;

        // Use setTimeout to queue UI updates
        setTimeout(() => {
            // Update the classes of player elements
            for (let i = 1; i <= numPlayers; i++) {
                let playerElement = document.getElementById('player' + i);
                if (playerElement) {
                    if (i === striker) {
                        playerElement.classList.add('on-strike');
                    } else {
                        playerElement.classList.remove('on-strike');
                    }
                } else {
                    console.warn("Player element not found for player:", i);
                    console.warn("Num players:", numPlayers);
                    return; // Exit function to prevent further warns
                }
            }
            updateScore(); // Call updateScore() here
        }, 0);
    }

    function switchStrikeIfSingleOrTriple(run) {
        if (run === 1 || run === 3) {
            if (ballsThisOver !== totalBallsPerOver) {
                switchStrike(); // Switch strike if 1 or 3 on any ball except the 6th ball
            }
        }
    }

    function addRun(run) {
        // Increment runs and balls for the striker
        players[striker].runs += run;
        players[striker].balls++;
        ballsThisOver++;

        // Increment fours or sixes if applicable
        if (run === 4) {
            players[striker].fours++;
        } else if (run === 6) {
            players[striker].sixes++;
        }

        // Check if the over is completed
        if (ballsThisOver === totalBallsPerOver) {
            switchOver(); // Switch over if all balls have been bowled
            if (run !== 1 && run !== 3) {
                switchStrike(); // Switch strike if not 1 or 3 on the last ball of the over
            }
        } else if (ballsThisOver < totalBallsPerOver) {
            // Switch strike if 1 or 3 is scored
            switchStrikeIfSingleOrTriple(run);
        }
        updateScorecard();
        updateScore();
    }

    function addWide() {
        players[striker].runs++;
        players[striker].extras++;
        updateScorecard();
        updateScore();
    }

    function addNoBall() {
        players[striker].runs++;
        players[striker].extras++;
        updateScorecard();
        updateScore();
    }

    function addBouncer() {
        // Additional functionality for bouncer can be added here
    }

    function undoLastAction() {
        // Additional functionality for undoing the last action can be added here
    }

    function updateNonStriker() {
        if (numPlayers === 1) {
            nonStriker = 0; // If only one player selected, nonStriker remains 0
        } else {
            nonStriker = 2; // If two or more players selected, nonStriker becomes 2
        }
    }

    function resetMatch() {
        // Reset all player scores and stats
        for (let player in players) {
            players[player].runs = 0;
            players[player].balls = 0;
            players[player].fours = 0;
            players[player].sixes = 0;
            players[player].extras = 0;
        }

        // Reset other game variables
        wickets = [];
        overs = 0;
        ballsThisOver = 0;

        // Reset score and scoreboard display
        updateScore();
        updateScorecard();

        // Remove the "on-strike" class from all players
        let allPlayers = document.querySelectorAll('.on-strike');
        allPlayers.forEach(player => {
            player.classList.remove('on-strike');
        });

        // Add the "on-strike" class to player 1
        document.getElementById('player1').classList.add('on-strike');

        console.log("RESET")
    }

    function showWicketsList() {
        let modal = document.getElementById('wickets-modal');
        if (modal) {
            modal.style.display = 'block'; // Show the modal
        } else {
            console.warn("Modal element not found.");
        }

        let closeButton = document.querySelector('.close');

        // Add event listener to the close button
        if (closeButton) {
            closeButton.addEventListener('click', function () {
                // Get the modal element
                let modal = document.getElementById('wickets-modal');
                if (modal) {
                    modal.style.display = 'none'; // Hide the modal
                } else {
                    console.warn("Modal element not found.");
                }
            });
        } else {
            console.warn("Close button element not found.");
        }
    }

    // Add event listener to the "Show Wickets" button
    document.getElementById('show-wickets-button').addEventListener('click', showWicketsList);

    function updateConsoleLogViewer() {
        var consoleLogViewer = document.getElementById('console-log-viewer');
        consoleLogViewer.innerHTML = '';

        // Get all console log messages
        var logs = [];
        for (var i = 0; i < console.logHistory.length; i++) {
            logs.push(console.logHistory[i]);
        }

        // Display logs in reverse order (most recent first)
        logs.reverse();

        // Add logs to the viewer
        for (var i = 0; i < logs.length; i++) {
            var logEntry = document.createElement('div');
            logEntry.textContent = logs[i];
            consoleLogViewer.appendChild(logEntry);
        }
    }

    // Override console.log to capture log messages
    console.logHistory = [];
    console._log = console.log;
    console.log = function () {
        // Capture log messages
        console._log.apply(this, arguments);
        var message = Array.prototype.join.call(arguments, ' ');
        console.logHistory.push(message);

        // Limit log history to 10 messages
        if (console.logHistory.length > 10) {
            console.logHistory.shift();
        }

        // Update console log viewer
        updateConsoleLogViewer();
    };

</script>